<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M.I.A. World Influence Map</title>
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    :root {
      --bg: #0b0b0b;
      --fg: #f5f5f5;
      --muted: #9aa0a6;
      --mention: #5b9bd5;
      --sample: #f59e0b;
      --language: #34d399;
      --hover: #ffffff;
    }
    html, body { height: 100%; margin: 0; }
    body { background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    header { max-width: 1100px; margin: 16px auto 0; padding: 0 16px; }
    .hstack { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .legend { display: inline-flex; align-items: center; gap: 10px; font-size: 14px; }
    .legend > span { display: inline-flex; align-items: center; gap: 6px; }
    .swatch { width: 12px; height: 12px; border-radius: 2px; display: inline-block; }
    .filters { margin-left: auto; display: inline-flex; gap: 8px; }
    .filters label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; color: var(--muted); }
    .filters input:checked + span { color: var(--fg); }
    .wrap { max-width: 1100px; margin: 8px auto 40px; padding: 0 16px; }
    .map { width: 100%; height: clamp(340px, 60vh, 720px); background: #111; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35); position: relative; }
    svg { width: 100%; height: 100%; display: block; }
    .tooltip { position: absolute; pointer-events: none; background: rgba(20,20,20,.96); color: var(--fg); padding: 10px 12px; border: 1px solid rgba(255,255,255,.08); border-radius: 10px; font-size: 13px; line-height: 1.35; max-width: 280px; transform: translate(-50%, -110%); backdrop-filter: blur(4px); box-shadow: 0 8px 26px rgba(0,0,0,.5); }
    .tooltip .title { font-weight: 600; margin-bottom: 6px; }
    .tooltip .meta { color: var(--muted); font-size: 12px; margin-top: 6px; }
    footer { max-width: 1100px; margin: 0 auto 24px; padding: 0 16px; color: var(--muted); font-size: 13px; }
    a { color: #b6c8ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header class="hstack">
    <h1 style="font-size: 22px; margin: 0; letter-spacing:.3px;">M.I.A.'s Global References</h1>
    <div class="legend" aria-label="Legend">
      <span><i class="swatch" style="background: var(--mention)"></i>Lyric mention</span>
      <span><i class="swatch" style="background: var(--sample)"></i>Sample origin</span>
      <span><i class="swatch" style="background: var(--language)"></i>Language use</span>
    </div>
    <div class="filters" role="group" aria-label="Filter markers">
      <label><input type="checkbox" data-type="mention" checked><span>Mentions</span></label>
      <label><input type="checkbox" data-type="sample" checked><span>Samples</span></label>
      <label><input type="checkbox" data-type="language" checked><span>Languages</span></label>
    </div>
  </header>

  <div class="wrap">
    <div id="map" class="map">
      <div id="tooltip" class="tooltip" style="opacity:0"></div>
      <svg id="svg" viewBox="0 0 1100 620" aria-label="World map"></svg>
    </div>
  </div>

  <footer>
    <p>Hover a highlighted country to hear a short clip. Data loads from <code>data/references.json</code>. Replace demo audio paths with your own.</p>
  </footer>

<script>
(async function main() {
  const typeColor = (t) => ({ mention: css('--mention'), sample: css('--sample'), language: css('--language') }[t] || '#777');
  function css(v) { return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

  const filterState = { mention: true, sample: true, language: true };
  document.querySelectorAll('.filters input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      filterState[cb.dataset.type] = cb.checked;
      redraw();
    });
  });

  // Fetch references JSON (generated by scraper)
  const refs = await fetch('data/references.json').then(r => r.json()).catch(() => []);

  const byIso = new Map(refs.map(d => [d.iso3, d]));

  const world = await fetch('https://unpkg.com/world-atlas@2/countries-110m.json').then(r => r.json());
  const { features: countries } = topojson.feature(world, world.objects.countries);

  const svg = d3.select('#svg');
  const g = svg.append('g');
  const projection = d3.geoNaturalEarth1().fitSize([1100, 620], { type: 'Sphere' });
  const path = d3.geoPath(projection);

  const graticule = d3.geoGraticule10();
  g.append('path').attr('d', path({ type: 'Sphere' })).attr('fill', '#0f1115');
  g.append('path').attr('d', path(graticule)).attr('fill', 'none').attr('stroke', 'rgba(255,255,255,.06)').attr('stroke-width', 0.6);

  const tooltip = d3.select('#tooltip');
  let currentAudio = null;

  function stopAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
  }

  function playAudio(src) {
    try {
      stopAudio();
      if (!src) return;
      const a = new Audio(src);
      a.volume = 0.85;
      a.play().catch(()=>{});
      currentAudio = a;
    } catch (e) {}
  }

  function activeRefsFor(iso3, name) {
    const entry = byIso.get(iso3);
    if (!entry) return [];
    return entry.refs.filter(r => filterState[r.type]);
  }

  function colorForCountry(iso3, name) {
    const act = activeRefsFor(iso3, name);
    if (!act.length) return '#1a1d22';
    if (act.length > 1) return '#232a33';
    return typeColor(act[0].type);
  }

  function firstActiveRef(iso3, name) {
    const act = activeRefsFor(iso3, name);
    return act[0] || null;
  }

  function redraw() {
    const countryPaths = g.selectAll('path.country').data(countries, d => d.id);

    countryPaths.enter().append('path')
      .attr('class', 'country')
      .attr('d', path)
      .attr('fill', d => colorForCountry(d.properties.iso_a3 || d.id, d.properties.name))
      .attr('stroke', '#10131a')
      .attr('stroke-width', 0.5)
      .on('mouseenter', function (event, d) {
        d3.select(this).attr('stroke', css('--hover')).attr('stroke-width', 1.1);
        const ref = firstActiveRef(d.properties.iso_a3 || d.id, d.properties.name);
        const hasRef = !!ref;
        const x = event.offsetX, y = event.offsetY;
        if (hasRef) {
          const lines = [
            `<div class="title">${d.properties.name}</div>`,
            `<div>${ref.song} <span class="meta">(${ref.year || ''}${ref.album ? ', ' + ref.album : ''})</span></div>`,
            ref.type === 'sample' && ref.source ? `<div class="meta">Sample: ${ref.source}</div>` : '',
            ref.lyric ? `<div class="meta">“${ref.lyric}”</div>` : ''
          ].join('');
          tooltip.html(lines).style('left', x + 'px').style('top', y + 'px').style('opacity', 1);
          playAudio(ref.audio);
        } else {
          tooltip.style('opacity', 0);
        }
      })
      .on('mousemove', function (event) {
        tooltip.style('left', event.offsetX + 'px').style('top', event.offsetY + 'px');
      })
      .on('mouseleave', function () {
        d3.select(this).attr('stroke', '#10131a').attr('stroke-width', 0.5);
        tooltip.style('opacity', 0);
        stopAudio();
      })
      .on('click', function(event, d){
        const ref = firstActiveRef(d.properties.iso_a3 || d.id, d.properties.name);
        if (!ref) return;
        console.log('Clicked', d.properties.name, ref);
      });

    countryPaths
      .attr('fill', d => colorForCountry(d.properties.iso_a3 || d.id, d.properties.name));

    countryPaths.exit().remove();
  }

  redraw();
})();
</script>
</body>
</html>